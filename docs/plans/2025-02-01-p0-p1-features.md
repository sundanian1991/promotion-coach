# æ™‹å‡è¾…å¯¼ P0/P1 åŠŸèƒ½ä¸ UI/UX æ”¹è¿›å®æ–½è®¡åˆ’

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**ç›®æ ‡:** ä¸ºæ™‹å‡è¾…å¯¼åº”ç”¨æ·»åŠ æ•°æ®å¯è§†åŒ–ã€æ™ºèƒ½æ¨èã€å½•éŸ³åŠŸèƒ½ã€PDF å¯¼å‡ºï¼Œä»¥åŠå¤šé¡¹ UI/UX ä¼˜åŒ–

**æ¶æ„:** åŸºäºç°æœ‰ Next.js 15 + Zustand æ¶æ„ï¼Œæ–°å¢ Tremor å›¾è¡¨åº“ã€react-to-pdf å¯¼å‡ºåº“ï¼Œä»¥åŠè‡ªå®šä¹‰ hooks å®ç°ä¸»é¢˜å’Œå¿«æ·é”®ç®¡ç†

**æŠ€æœ¯æ ˆ:** Next.js 15, React 19, Tremor (å›¾è¡¨), react-pdf/jspdf (å¯¼å‡º), Web Speech API (å½•éŸ³), Zustand (çŠ¶æ€ç®¡ç†)

---

## ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½

### Task 1: å®‰è£…å¿…è¦ä¾èµ–

**Files:**
- Modify: `/Users/sundanian/cowork/promotion-coach/app/package.json`

**Step 1: å®‰è£…å›¾è¡¨åº“ Tremor**

```bash
npm install @tremor/react@latest
```

**Step 2: å®‰è£… PDF å¯¼å‡ºåº“**

```bash
npm install jspdf html2canvas @react-pdf/renderer
```

**Step 3: å®‰è£…å¿«æ·é”®åº“**

```bash
npm install react-hotkeys-hook
```

**Step 4: å®‰è£…æ‰‹åŠ¿åº“ï¼ˆç§»åŠ¨ç«¯æ»‘åŠ¨ï¼‰**

```bash
npm install use-gesture react-spring
```

**Step 5: éªŒè¯å®‰è£…**

```bash
npm run build
```

**é¢„æœŸè¾“å‡º:** æ„å»ºæˆåŠŸï¼Œæ— ä¾èµ–é”™è¯¯

---

## ç¬¬äºŒé˜¶æ®µï¼šP0 åŠŸèƒ½ - æ•°æ®å¯è§†åŒ–

### Task 2: åˆ›å»ºç»ƒä¹ æ•°æ®ç»Ÿè®¡ Hook

**Files:**
- Create: `/Users/sundanian/cowork/promotion-coach/app/lib/hooks/usePracticeStats.ts`
- Create: `/Users/sundanian/cowork/promotion-coach/app/lib/hooks/__tests__/usePracticeStats.test.ts`

**Step 1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶**

```typescript
// lib/hooks/__tests__/usePracticeStats.test.ts
import { renderHook } from '@testing-library/react';
import { usePracticeStats } from '../usePracticeStats';

describe('usePracticeStats', () => {
  it('should return empty data when no records', () => {
    const { result } = renderHook(() => usePracticeStats([]));
    expect(result.current.dailyStats).toEqual([]);
    expect(result.current.segmentDistribution).toEqual([]);
  });

  it('should calculate daily stats correctly', () => {
    const records = [
      { id: '1', date: '2025-02-01', segmentId: 'opening', duration: 120 },
      { id: '2', date: '2025-02-01', segmentId: 'upgrade1', duration: 180 },
    ];
    const { result } = renderHook(() => usePracticeStats(records));
    expect(result.current.dailyStats[0].date).toBe('2025-02-01');
    expect(result.current.dailyStats[0].duration).toBe(300);
  });
});
```

**Step 2: è¿è¡Œæµ‹è¯•ç¡®è®¤å¤±è´¥**

```bash
npm test -- lib/hooks/__tests__/usePracticeStats.test.ts
```

**é¢„æœŸè¾“å‡º:** FAIL - file not found

**Step 3: åˆ›å»º Hook å®ç°**

```typescript
// lib/hooks/usePracticeStats.ts
import { useMemo } from 'react';
import type { PracticeRecord } from '@/types';

export interface DailyStat {
  date: string;
  duration: number;
  count: number;
}

export interface SegmentStat {
  segmentId: string;
  segmentName: string;
  duration: number;
  count: number;
  percentage: number;
}

export function usePracticeStats(records: PracticeRecord[]) {
  const dailyStats = useMemo(() => {
    const grouped = new Map<string, DailyStat>();
    records.forEach((record) => {
      const date = record.date.split('T')[0];
      const existing = grouped.get(date) || { date, duration: 0, count: 0 };
      grouped.set(date, {
        date,
        duration: existing.duration + record.duration,
        count: existing.count + 1,
      });
    });
    return Array.from(grouped.values()).sort((a, b) => a.date.localeCompare(b.date));
  }, [records]);

  const segmentDistribution = useMemo(() => {
    const grouped = new Map<string, SegmentStat>();
    const segmentNames: Record<string, string> = {
      opening: 'å¼€åœº',
      upgrade1: 'å‡çº§ä¸€',
      upgrade2: 'å‡çº§äºŒ',
      upgrade3: 'å‡çº§ä¸‰',
      summary: 'æ€»ç»“',
      future: 'æœªæ¥',
      full: 'å®Œæ•´ç‰ˆ',
    };

    records.forEach((record) => {
      const existing = grouped.get(record.segmentId) || {
        segmentId: record.segmentId,
        segmentName: segmentNames[record.segmentId] || record.segmentId,
        duration: 0,
        count: 0,
        percentage: 0,
      };
      grouped.set(record.segmentId, {
        ...existing,
        duration: existing.duration + record.duration,
        count: existing.count + 1,
      });
    });

    const total = Array.from(grouped.values()).reduce((sum, s) => sum + s.duration, 0);
    return Array.from(grouped.values()).map((s) => ({
      ...s,
      percentage: total > 0 ? Math.round((s.duration / total) * 100) : 0,
    }));
  }, [records]);

  const totalDuration = useMemo(() => {
    return records.reduce((sum, r) => sum + r.duration, 0);
  }, [records]);

  return { dailyStats, segmentDistribution, totalDuration };
}
```

**Step 4: è¿è¡Œæµ‹è¯•ç¡®è®¤é€šè¿‡**

```bash
npm test -- lib/hooks/__tests__/usePracticeStats.test.ts
```

**é¢„æœŸè¾“å‡º:** PASS

**Step 5: æäº¤**

```bash
git add lib/hooks/
git commit -m "feat: add usePracticeStats hook with tests"
```

---

### Task 3: åˆ›å»ºç»Ÿè®¡å›¾è¡¨ç»„ä»¶

**Files:**
- Create: `/Users/sundanian/cowork/promotion-coach/app/components/dashboard/practice-charts.tsx`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/app/page.tsx`

**Step 1: åˆ›å»ºå›¾è¡¨ç»„ä»¶**

```typescript
// components/dashboard/practice-charts.tsx
'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { usePracticeStats } from '@/lib/hooks/usePracticeStats';
import { usePracticeRecords } from '@/lib/store';
import {
  AreaChart,
  BarChart,
  Card as TremorCard,
  Title,
  AreaChart as TremorAreaChart,
  BarList,
} from '@tremor/react';
import { TrendingUp, Calendar } from 'lucide-react';
import { format } from 'date-fns';
import { zhCN } from 'date-fns/locale';

const dataFormatter = (number: number) => {
  return `${Math.floor(number / 60)}åˆ†${number % 60}ç§’`;
};

export function PracticeCharts() {
  const records = usePracticeRecords();
  const { dailyStats, segmentDistribution } = usePracticeStats(records);

  // å‡†å¤‡è¶‹åŠ¿å›¾æ•°æ®
  const chartData = dailyStats.slice(-14).map((stat) => ({
    æ—¥æœŸ: format(new Date(stat.date), 'Mæœˆdæ—¥', { locale: zhCN }),
    æ—¶é•¿: Math.round(stat.duration / 60),
    æ¬¡æ•°: stat.count,
  }));

  // å‡†å¤‡åˆ†å¸ƒå›¾æ•°æ®
  const distributionData = segmentDistribution.map((s) => ({
    name: s.segmentName,
    value: Math.round(s.duration / 60),
    percentage: s.percentage,
  }));

  if (records.length === 0) {
    return (
      <Card className="col-span-4">
        <CardContent className="flex flex-col items-center justify-center py-12">
          <Calendar className="w-12 h-12 text-muted-foreground mb-4" />
          <p className="text-muted-foreground">å¼€å§‹ç»ƒä¹ åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºä½ çš„å­¦ä¹ è¶‹åŠ¿</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <>
      {/* ç»ƒä¹ è¶‹åŠ¿å›¾ - 14å¤© */}
      <div className="md:col-span-2">
        <Card className="h-full hover-lift">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-base">
              <div className="w-8 h-8 rounded-lg bg-secondary flex items-center justify-center">
                <TrendingUp className="w-4 h-4" />
              </div>
              14å¤©ç»ƒä¹ è¶‹åŠ¿
            </CardTitle>
          </CardHeader>
          <CardContent>
            {chartData.length > 0 ? (
              <AreaChart
                className="h-48 mt-4"
                data={chartData}
                index="æ—¥æœŸ"
                categories={['æ—¶é•¿']}
                colors={['#0066FF']}
                valueFormatter={(value) => `${value}åˆ†é’Ÿ`}
                showAnimation={true}
              />
            ) : (
              <p className="text-sm text-muted-foreground text-center py-8">
                æš‚æ— æ•°æ®
              </p>
            )}
          </CardContent>
        </Card>
      </div>

      {/* æ®µè½åˆ†å¸ƒå›¾ */}
      <div className="md:col-span-1">
        <Card className="h-full hover-lift">
          <CardHeader>
            <CardTitle className="text-base">æ®µè½åˆ†å¸ƒ</CardTitle>
          </CardHeader>
          <CardContent>
            {distributionData.length > 0 ? (
              <BarList
                data={distributionData}
                className="mx-auto max-w-xs"
                valueFormatter={(value) => `${value}åˆ†é’Ÿ`}
                color="#0066FF"
              />
            ) : (
              <p className="text-sm text-muted-foreground text-center py-8">
                æš‚æ— æ•°æ®
              </p>
            )}
          </CardContent>
        </Card>
      </div>

      {/* çƒ­åŠ›å›¾ - 30å¤© */}
      <div className="md:col-span-1">
        <Card className="h-full hover-lift">
          <CardHeader>
            <CardTitle className="text-base">ç»ƒä¹ çƒ­åŠ›å›¾</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-7 gap-1">
              {Array.from({ length: 35 }).map((_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (34 - i));
                const dateStr = date.toISOString().split('T')[0];
                const hasPractice = dailyStats.some((s) => s.date === dateStr);
                const intensity = dailyStats.find((s) => s.date === dateStr)?.duration || 0;

                return (
                  <div
                    key={i}
                    className={`
                      aspect-square rounded-sm
                      ${!hasPractice ? 'bg-secondary/30' :
                        intensity < 120 ? 'bg-primary/30' :
                        intensity < 300 ? 'bg-primary/60' :
                        'bg-primary'
                      }
                    `}
                    title={`${dateStr}: ${Math.floor(intensity / 60)}åˆ†é’Ÿ`}
                  />
                );
              })}
            </div>
            <div className="flex items-center justify-between mt-3 text-xs text-muted-foreground">
              <span>30å¤©å‰</span>
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 rounded-sm bg-secondary/30" />
                <div className="w-3 h-3 rounded-sm bg-primary/30" />
                <div className="w-3 h-3 rounded-sm bg-primary/60" />
                <div className="w-3 h-3 rounded-sm bg-primary" />
              </div>
              <span>ä»Šå¤©</span>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  );
}
```

**Step 2: åœ¨é¦–é¡µé›†æˆå›¾è¡¨**

```typescript
// app/page.tsx - åœ¨ Bento Grid ä¸­æ·»åŠ å›¾è¡¨
import { PracticeCharts } from '@/components/dashboard/practice-charts';

// åœ¨ç½‘æ ¼åº•éƒ¨æ·»åŠ ï¼ˆåœ¨å¿«é€Ÿå¼€å§‹å¡ç‰‡ä¹‹å‰ï¼‰:
<PracticeCharts />
```

**Step 3: éªŒè¯æ„å»º**

```bash
npm run build
```

**é¢„æœŸè¾“å‡º:** æ„å»ºæˆåŠŸ

**Step 4: æäº¤**

```bash
git add components/dashboard/practice-charts.tsx app/page.tsx
git commit -m "feat: add practice statistics charts with Tremor"
```

---

### Task 4: æ™ºèƒ½æ¨èè–„å¼±ç¯èŠ‚

**Files:**
- Create: `/Users/sundanian/cowork/promotion-coach/app/lib/hooks/useWeaknessAnalysis.ts`
- Create: `/Users/sundanian/cowork/promotion-coach/app/components/dashboard/weakness-tips.tsx`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/app/page.tsx`

**Step 1: åˆ›å»ºè–„å¼±ç¯èŠ‚åˆ†æ Hook**

```typescript
// lib/hooks/useWeaknessAnalysis.ts
import { useMemo } from 'react';
import type { PracticeRecord } from '@/types';
import { usePracticeStats } from './usePracticeStats';

export interface WeaknessTip {
  type: 'segment' | 'frequency' | 'streak';
  priority: 'high' | 'medium' | 'low';
  title: string;
  description: string;
  action: string;
  actionLink: string;
}

const SEGMENT_NAMES: Record<string, string> = {
  opening: 'å¼€åœº',
  upgrade1: 'å‡çº§ä¸€',
  upgrade2: 'å‡çº§äºŒ',
  upgrade3: 'å‡çº§ä¸‰',
  summary: 'æ€»ç»“',
  future: 'æœªæ¥',
  full: 'å®Œæ•´ç‰ˆ',
};

export function useWeaknessAnalysis(records: PracticeRecord[]) {
  const { segmentDistribution, dailyStats } = usePracticeStats(records);

  const tips = useMemo((): WeaknessTip[] => {
    const tips: WeaknessTip[] = [];

    // åˆ†æ1: ç»ƒä¹ æœ€å°‘çš„æ®µè½
    if (segmentDistribution.length > 0) {
      const minSegment = segmentDistribution.reduce((min, s) =>
        s.count < min.count ? s : min
      );

      if (minSegment.count < 3) {
        tips.push({
          type: 'segment',
          priority: 'high',
          title: 'åŠ å¼ºè¿™ä¸ªæ®µè½ç»ƒä¹ ',
          description: `"${minSegment.segmentName}"åªç»ƒä¹ äº†${minSegment.count}æ¬¡ï¼Œå»ºè®®å¤šç»ƒä¹ `,
          action: `ç»ƒä¹ ${minSegment.segmentName}`,
          actionLink: `/practice/script/${minSegment.segmentId}`,
        });
      }
    }

    // åˆ†æ2: ç»ƒä¹ é¢‘ç‡ä¸è¶³
    const last7Days = dailyStats.slice(-7);
    const practicedDays = last7Days.filter((d) => d.count > 0).length;

    if (practicedDays < 4) {
      tips.push({
        type: 'frequency',
        priority: 'high',
        title: 'ä¿æŒç»ƒä¹ èŠ‚å¥',
        description: `è¿‡å»7å¤©åªç»ƒä¹ äº†${practicedDays}å¤©ï¼Œå»ºè®®æ¯å¤©è‡³å°‘ç»ƒä¹ ä¸€æ¬¡`,
        action: 'å¼€å§‹ç»ƒä¹ ',
        actionLink: '/practice',
      });
    }

    // åˆ†æ3: è¿ç»­ç»ƒä¹ ä¸­æ–­æé†’
    const today = new Date().toISOString().split('T')[0];
    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
    const hasTodayPractice = dailyStats.some((d) => d.date === today);
    const hasYesterdayPractice = dailyStats.some((d) => d.date === yesterday);

    if (hasYesterdayPractice && !hasTodayPractice) {
      tips.push({
        type: 'streak',
        priority: 'medium',
        title: 'ä¿æŒè¿ç»­ç»ƒä¹ ',
        description: 'æ˜¨å¤©ç»ƒä¹ äº†ï¼Œä»Šå¤©ç»§ç»­ä¿æŒï¼',
        action: 'å¼€å§‹ç»ƒä¹ ',
        actionLink: '/practice',
      });
    }

    // åˆ†æ4: å•æ¬¡ç»ƒä¹ æ—¶é•¿ä¸è¶³
    const recentRecords = records.slice(-5);
    const avgDuration = recentRecords.reduce((sum, r) => sum + r.duration, 0) / recentRecords.length;

    if (recentRecords.length > 0 && avgDuration < 180) {
      tips.push({
        type: 'frequency',
        priority: 'medium',
        title: 'é€‚å½“å»¶é•¿ç»ƒä¹ æ—¶é•¿',
        description: `æœ€è¿‘å¹³å‡ç»ƒä¹ æ—¶é•¿${Math.floor(avgDuration / 60)}åˆ†é’Ÿï¼Œå»ºè®®æ¯æ¬¡è‡³å°‘5åˆ†é’Ÿ`,
        action: 'å¼€å§‹å®Œæ•´ç»ƒä¹ ',
        actionLink: '/practice/script/full',
      });
    }

    return tips.sort((a, b) => {
      const priorityOrder = { high: 0, medium: 1, low: 2 };
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    });
  }, [records, segmentDistribution, dailyStats]);

  return { tips, topTip: tips[0] };
}
```

**Step 2: åˆ›å»ºæ¨èæç¤ºç»„ä»¶**

```typescript
// components/dashboard/weakness-tips.tsx
'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { useWeaknessAnalysis } from '@/lib/hooks/useWeaknessAnalysis';
import { usePracticeRecords } from '@/lib/store';
import { Lightbulb, TrendingDown, AlertCircle, ArrowRight } from 'lucide-react';
import Link from 'next/link';
import { cn } from '@/lib/utils';

export function WeaknessTips() {
  const records = usePracticeRecords();
  const { tips } = useWeaknessAnalysis(records);

  if (tips.length === 0) {
    return null;
  }

  const getIcon = (type: string) => {
    switch (type) {
      case 'segment':
        return TrendingDown;
      case 'frequency':
        return AlertCircle;
      case 'streak':
        return Lightbulb;
      default:
        return Lightbulb;
    }
  };

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'high':
        return 'text-destructive bg-destructive/10';
      case 'medium':
        return 'text-orange-600 bg-orange-100 dark:bg-orange-900/20';
      default:
        return 'text-primary bg-primary/10';
    }
  };

  return (
    <div className="md:col-span-4">
      <Card className="border-primary/20 hover-lift">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Lightbulb className="w-5 h-5 text-primary" />
            æ™ºèƒ½å»ºè®®
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            {tips.slice(0, 3).map((tip, index) => {
              const Icon = getIcon(tip.type);
              return (
                <div
                  key={index}
                  className="p-4 rounded-lg border bg-card hover:bg-accent/50 transition-colors"
                >
                  <div className="flex items-start justify-between mb-2">
                    <div className="w-8 h-8 rounded-lg bg-secondary flex items-center justify-center">
                      <Icon className="w-4 h-4" />
                    </div>
                    <Badge variant="outline" className={cn('text-xs', getPriorityColor(tip.priority))}>
                      {tip.priority === 'high' ? 'é‡è¦' : tip.priority === 'medium' ? 'å»ºè®®' : 'æç¤º'}
                    </Badge>
                  </div>
                  <h4 className="font-medium text-sm mb-1">{tip.title}</h4>
                  <p className="text-xs text-muted-foreground mb-3">{tip.description}</p>
                  <Link href={tip.actionLink}>
                    <Button size="sm" variant="outline" className="w-full group">
                      {tip.action}
                      <ArrowRight className="w-3 h-3 ml-1 group-hover:translate-x-0.5 transition-transform" />
                    </Button>
                  </Link>
                </div>
              );
            })}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

**Step 3: åœ¨é¦–é¡µé›†æˆæ™ºèƒ½å»ºè®®**

```typescript
// app/page.tsx - æ·»åŠ æ™ºèƒ½å»ºè®®ç»„ä»¶
import { WeaknessTips } from '@/components/dashboard/weakness-tips';

// åœ¨ Bento Grid ä¸­æ·»åŠ ï¼ˆåœ¨å›¾è¡¨ä¹‹åï¼‰:
<WeaknessTips />
```

**Step 4: éªŒè¯æ„å»º**

```bash
npm run build
```

**é¢„æœŸè¾“å‡º:** æ„å»ºæˆåŠŸ

**Step 5: æäº¤**

```bash
git add lib/hooks/useWeaknessAnalysis.ts components/dashboard/weakness-tips.tsx app/page.tsx
git commit -m "feat: add intelligent weakness analysis and recommendations"
```

---

## ç¬¬ä¸‰é˜¶æ®µï¼šP1 åŠŸèƒ½ - å½•éŸ³ä¸å¯¼å‡º

### Task 5: è¯­éŸ³å½•éŸ³åŠŸèƒ½

**Files:**
- Create: `/Users/sundanian/cowork/promotion-coach/app/lib/hooks/useAudioRecorder.ts`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/components/practice/timer-display.tsx`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/components/practice/script-viewer.tsx`

**Step 1: åˆ›å»ºå½•éŸ³ Hook**

```typescript
// lib/hooks/useAudioRecorder.ts
import { useState, useRef, useCallback } from 'react';

export interface AudioRecording {
  blob: Blob;
  url: string;
  duration: number;
  timestamp: string;
}

export function useAudioRecorder() {
  const [isRecording, setIsRecording] = useState(false);
  const [recordings, setRecordings] = useState<AudioRecording[]>([]);
  const [duration, setDuration] = useState(0);
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const chunksRef = useRef<Blob[]>([]);
  const timerRef = useRef<NodeJS.Timeout | null>(null);

  const startRecording = useCallback(async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      mediaRecorderRef.current = mediaRecorder;
      chunksRef.current = [];

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          chunksRef.current.push(event.data);
        }
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        const recording: AudioRecording = {
          blob,
          url,
          duration,
          timestamp: new Date().toISOString(),
        };
        setRecordings((prev) => [...prev, recording]);
        stream.getTracks().forEach((track) => track.stop());
      };

      mediaRecorder.start();
      setIsRecording(true);
      setDuration(0);

      timerRef.current = setInterval(() => {
        setDuration((d) => d + 1);
      }, 1000);
    } catch (error) {
      console.error('Error starting recording:', error);
      throw new Error('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
    }
  }, [duration]);

  const stopRecording = useCallback(() => {
    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
      mediaRecorderRef.current.stop();
      setIsRecording(false);
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    }
  }, []);

  const deleteRecording = useCallback((index: number) => {
    setRecordings((prev) => {
      const newRecordings = [...prev];
      const deleted = newRecordings.splice(index, 1)[0];
      URL.revokeObjectURL(deleted.url);
      return newRecordings;
    });
  }, []);

  const clearAllRecordings = useCallback(() => {
    recordings.forEach((r) => URL.revokeObjectURL(r.url));
    setRecordings([]);
  }, [recordings]);

  return {
    isRecording,
    recordings,
    duration,
    startRecording,
    stopRecording,
    deleteRecording,
    clearAllRecordings,
  };
}
```

**Step 2: åˆ›å»ºå½•éŸ³æ’­æ”¾å™¨ç»„ä»¶**

```typescript
// components/practice/audio-recorder.tsx
'use client';

import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Mic, MicOff, Play, Pause, Trash2, Download } from 'lucide-react';
import { useAudioRecorder } from '@/lib/hooks/useAudioRecorder';
import { cn } from '@/lib/utils';
import { useState, useRef, useEffect } from 'react';

export function AudioRecorder() {
  const {
    isRecording,
    recordings,
    duration,
    startRecording,
    stopRecording,
    deleteRecording,
    clearAllRecordings,
  } = useAudioRecorder();

  const [playingIndex, setPlayingIndex] = useState<number | null>(null);
  const audioRefs = useRef<(HTMLAudioElement | null)[]>([]);

  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const handlePlay = (index: number) => {
    if (playingIndex === index) {
      audioRefs.current[index]?.pause();
      setPlayingIndex(null);
    } else {
      audioRefs.current.forEach((audio, i) => {
        if (i !== index) audio?.pause();
      });
      audioRefs.current[index]?.play();
      setPlayingIndex(index);
    }
  };

  const handleDownload = (recording: AudioRecording, index: number) => {
    const a = document.createElement('a');
    a.href = recording.url;
    a.download = `practice-${recording.timestamp.split('T')[0]}.webm`;
    a.click();
  };

  return (
    <Card>
      <CardContent className="p-4">
        <div className="flex items-center gap-4">
          {/* å½•éŸ³æŒ‰é’® */}
          <Button
            size="lg"
            variant={isRecording ? 'destructive' : 'default'}
            onClick={isRecording ? stopRecording : startRecording}
            className={cn('gap-2', isRecording && 'animate-pulse')}
          >
            {isRecording ? (
              <>
                <MicOff className="w-4 h-4" />
                åœæ­¢
              </>
            ) : (
              <>
                <Mic className="w-4 h-4" />
                å½•éŸ³
              </>
            )}
          </Button>

          {/* æ—¶é•¿æ˜¾ç¤º */}
          <div className="text-center min-w-[80px]">
            <div className="text-2xl font-mono font-bold">{formatTime(duration)}</div>
            {isRecording && <div className="text-xs text-muted-foreground">å½•åˆ¶ä¸­...</div>}
          </div>

          {/* å½•éŸ³åˆ—è¡¨ */}
          {recordings.length > 0 && (
            <div className="flex-1 space-y-2">
              {recordings.map((recording, index) => (
                <div
                  key={index}
                  className="flex items-center gap-2 p-2 rounded-lg bg-secondary/50"
                >
                  <audio
                    ref={(el) => (audioRefs.current[index] = el)}
                    src={recording.url}
                    onEnded={() => setPlayingIndex(null)}
                    className="hidden"
                  />
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => handlePlay(index)}
                  >
                    {playingIndex === index ? (
                      <Pause className="w-3 h-3" />
                    ) : (
                      <Play className="w-3 h-3" />
                    )}
                  </Button>
                  <span className="text-sm flex-1">{formatTime(recording.duration)}</span>
                  <Button
                    size="sm"
                    variant="ghost"
                    onClick={() => handleDownload(recording, index)}
                  >
                    <Download className="w-3 h-3" />
                  </Button>
                  <Button
                    size="sm"
                    variant="ghost"
                    onClick={() => deleteRecording(index)}
                  >
                    <Trash2 className="w-3 h-3" />
                  </Button>
                </div>
              ))}
            </div>
          )}

          {/* æ¸…ç©ºæŒ‰é’® */}
          {recordings.length > 0 && (
            <Button
              size="sm"
              variant="ghost"
              onClick={clearAllRecordings}
            >
              æ¸…ç©º
            </Button>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
```

**Step 3: åœ¨è®¡æ—¶å™¨ç»„ä»¶ä¸­é›†æˆå½•éŸ³**

```typescript
// components/practice/timer-display.tsx - æ·»åŠ å½•éŸ³ç»„ä»¶å¯¼å…¥å’Œä½¿ç”¨
import { AudioRecorder } from './audio-recorder';

// åœ¨ TimerDisplay ç»„ä»¶çš„ CardContent ä¸­æ·»åŠ ï¼ˆåœ¨æ§åˆ¶æŒ‰é’®ä¹‹åï¼‰:
<AudioRecorder />
```

**Step 4: éªŒè¯æ„å»º**

```bash
npm run build
```

**é¢„æœŸè¾“å‡º:** æ„å»ºæˆåŠŸ

**Step 5: æäº¤**

```bash
git add lib/hooks/useAudioRecorder.ts components/practice/audio-recorder.tsx components/practice/timer-display.tsx
git commit -m "feat: add audio recording functionality for practice sessions"
```

---

### Task 6: PDF ç»ƒä¹ æŠ¥å‘Šå¯¼å‡º

**Files:**
- Create: `/Users/sundanian/cowork/promotion-coach/app/lib/hooks/usePracticeReport.ts`
- Create: `/Users/sundanian/cowork/promotion-coach/app/components/dashboard/report-export.tsx`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/app/page.tsx`

**Step 1: åˆ›å»ºæŠ¥å‘Šå¯¼å‡º Hook**

```typescript
// lib/hooks/usePracticeReport.ts
import { useMemo } from 'react';
import type { PracticeRecord } from '@/types';
import { usePracticeStats } from './usePracticeStats';
import jsPDF from 'jspdf';
import { format } from 'date-fns';
import { zhCN } from 'date-fns/locale';

export function usePracticeReport(records: PracticeRecord[]) {
  const { dailyStats, segmentDistribution, totalDuration } = usePracticeStats(records);

  const reportData = useMemo(() => {
    const totalHours = Math.floor(totalDuration / 3600);
    const totalMinutes = Math.floor((totalDuration % 3600) / 60);

    return {
      æ€»ä½“ç»Ÿè®¡: {
        æ€»ç»ƒä¹ æ—¶é•¿: `${totalHours}å°æ—¶${totalMinutes}åˆ†é’Ÿ`,
        æ€»ç»ƒä¹ æ¬¡æ•°: records.length,
        å¹³å‡æ¯æ¬¡æ—¶é•¿: records.length > 0
          ? `${Math.floor(totalDuration / records.length / 60)}åˆ†é’Ÿ`
          : '0åˆ†é’Ÿ',
        ç»ƒä¹ å¤©æ•°: dailyStats.length,
      },
      æ®µè½åˆ†å¸ƒ: segmentDistribution.map((s) => ({
        æ®µè½: s.segmentName,
        æ—¶é•¿: `${Math.floor(s.duration / 60)}åˆ†é’Ÿ`,
        æ¬¡æ•°: s.count,
        å æ¯”: `${s.percentage}%`,
      })),
      æœ€è¿‘ç»ƒä¹ : dailyStats.slice(-7).map((d) => ({
        æ—¥æœŸ: d.date,
        æ—¶é•¿: `${Math.floor(d.duration / 60)}åˆ†é’Ÿ`,
        æ¬¡æ•°: d.count,
      })),
    };
  }, [records, dailyStats, segmentDistribution, totalDuration]);

  const generatePDF = useCallback(() => {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 20;
    let yPosition = 20;

    // æ ‡é¢˜
    doc.setFontSize(20);
    doc.text('è¿°èŒç»ƒä¹ æŠ¥å‘Š', margin, yPosition);
    yPosition += 15;

    // ç”Ÿæˆæ—¥æœŸ
    doc.setFontSize(10);
    doc.text(`ç”Ÿæˆæ—¶é—´: ${format(new Date(), 'yyyyå¹´MMæœˆddæ—¥ HH:mm', { locale: zhCN })}`, margin, yPosition);
    yPosition += 15;

    // æ€»ä½“ç»Ÿè®¡
    doc.setFontSize(14);
    doc.text('æ€»ä½“ç»Ÿè®¡', margin, yPosition);
    yPosition += 8;
    doc.setFontSize(10);
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 5;

    Object.entries(reportData.æ€»ä½“ç»Ÿè®¡).forEach(([key, value]) => {
      doc.text(`${key}: ${value}`, margin, yPosition);
      yPosition += 6;
    });
    yPosition += 8;

    // æ®µè½åˆ†å¸ƒ
    doc.setFontSize(14);
    doc.text('æ®µè½åˆ†å¸ƒ', margin, yPosition);
    yPosition += 8;
    doc.setFontSize(10);
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 5;

    reportData.æ®µè½åˆ†å¸ƒ.forEach((item) => {
      doc.text(`${item.æ®µè½}: ${item.æ—¶é•¿} (${item.æ¬¡æ•°}æ¬¡, ${item.å æ¯”})`, margin, yPosition);
      yPosition += 6;
    });

    // æœ€è¿‘ç»ƒä¹ 
    if (yPosition > 250) {
      doc.addPage();
      yPosition = 20;
    }
    yPosition += 8;
    doc.setFontSize(14);
    doc.text('æœ€è¿‘7å¤©ç»ƒä¹ ', margin, yPosition);
    yPosition += 8;
    doc.setFontSize(10);
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 5;

    reportData.æœ€è¿‘ç»ƒä¹ .forEach((item) => {
      doc.text(`${item.æ—¥æœŸ}: ${item.æ—¶é•¿} (${item.æ¬¡æ•°}æ¬¡)`, margin, yPosition);
      yPosition += 6;
    });

    // ä¿å­˜
    doc.save(`è¿°èŒç»ƒä¹ æŠ¥å‘Š_${format(new Date(), 'yyyyMMdd')}.pdf`);
  }, [reportData]);

  return { reportData, generatePDF };
}
```

**Step 2: åˆ›å»ºå¯¼å‡ºæŒ‰é’®ç»„ä»¶**

```typescript
// components/dashboard/report-export.tsx
'use client';

import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { usePracticeReport } from '@/lib/hooks/usePracticeReport';
import { usePracticeRecords } from '@/lib/store';
import { Download, FileText } from 'lucide-react';
import { useState } from 'react';

export function ReportExport() {
  const records = usePracticeRecords();
  const { generatePDF } = usePracticeReport(records);
  const [isGenerating, setIsGenerating] = useState(false);

  const handleExport = async () => {
    setIsGenerating(true);
    try {
      generatePDF();
    } finally {
      setIsGenerating(false);
    }
  };

  if (records.length === 0) {
    return null;
  }

  return (
    <Card className="hover-lift">
      <CardContent className="p-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-lg bg-secondary flex items-center justify-center">
              <FileText className="w-5 h-5" />
            </div>
            <div>
              <h3 className="font-medium">å¯¼å‡ºç»ƒä¹ æŠ¥å‘Š</h3>
              <p className="text-sm text-muted-foreground">
                ç”ŸæˆåŒ…å«æ‰€æœ‰ç»ƒä¹ æ•°æ®çš„ PDF æŠ¥å‘Š
              </p>
            </div>
          </div>
          <Button
            onClick={handleExport}
            disabled={isGenerating}
            className="gap-2"
          >
            <Download className="w-4 h-4" />
            {isGenerating ? 'ç”Ÿæˆä¸­...' : 'å¯¼å‡º PDF'}
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
```

**Step 3: åœ¨é¦–é¡µé›†æˆå¯¼å‡ºåŠŸèƒ½**

```typescript
// app/page.tsx - æ·»åŠ å¯¼å‡ºç»„ä»¶
import { ReportExport } from '@/components/dashboard/report-export';

// åœ¨ Bento Grid ä¸­æ·»åŠ ï¼ˆåœ¨å¿«é€Ÿé“¾æ¥ä¹‹åï¼‰:
<ReportExport />
```

**Step 4: éªŒè¯æ„å»º**

```bash
npm run build
```

**é¢„æœŸè¾“å‡º:** æ„å»ºæˆåŠŸ

**Step 5: æäº¤**

```bash
git add lib/hooks/usePracticeReport.ts components/dashboard/report-export.tsx app/page.tsx
git commit -m "feat: add PDF practice report export functionality"
```

---

## ç¬¬å››é˜¶æ®µï¼šUI/UX æ”¹è¿›

### Task 7: æ·±è‰²æ¨¡å¼åˆ‡æ¢

**Files:**
- Create: `/Users/sundanian/cowork/promotion-coach/app/lib/hooks/useTheme.ts`
- Create: `/Users/sundanian/cowork/promotion-coach/app/components/theme/theme-toggle.tsx`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/components/layout/header.tsx`

**Step 1: åˆ›å»ºä¸»é¢˜ Hook**

```typescript
// lib/hooks/useTheme.ts
import { useEffect, useState } from 'react';

type Theme = 'light' | 'dark' | 'system';

export function useTheme() {
  const [theme, setTheme] = useState<Theme>('system');
  const [resolvedTheme, setResolvedTheme] = useState<'light' | 'dark'>('light');

  useEffect(() => {
    const stored = localStorage.getItem('theme') as Theme;
    if (stored) {
      setTheme(stored);
    }
  }, []);

  useEffect(() => {
    const root = document.documentElement;
    const isDark = theme === 'dark' ||
      (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);

    setResolvedTheme(isDark ? 'dark' : 'light');

    if (isDark) {
      root.classList.add('dark');
    } else {
      root.classList.remove('dark');
    }
  }, [theme]);

  const setThemeAndStore = (newTheme: Theme) => {
    setTheme(newTheme);
    localStorage.setItem('theme', newTheme);
  };

  return { theme: resolvedTheme, setTheme: setThemeAndStore, themePreference: theme };
}
```

**Step 2: åˆ›å»ºä¸»é¢˜åˆ‡æ¢ç»„ä»¶**

```typescript
// components/theme/theme-toggle.tsx
'use client';

import { Button } from '@/components/ui/button';
import { Moon, Sun, Monitor } from 'lucide-react';
import { useTheme } from '@/lib/hooks/useTheme';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '@/components/ui/dropdown-menu';

export function ThemeToggle() {
  const { theme, setTheme, themePreference } = useTheme();

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" size="icon">
          <Sun className="h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0" />
          <Moon className="absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100" />
          <span className="sr-only">åˆ‡æ¢ä¸»é¢˜</span>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem onClick={() => setTheme('light')}>
          <Sun className="mr-2 h-4 w-4" />
          æµ…è‰²
        </DropdownMenuItem>
        <DropdownMenuItem onClick={() => setTheme('dark')}>
          <Moon className="mr-2 h-4 w-4" />
          æ·±è‰²
        </DropdownMenuItem>
        <DropdownMenuItem onClick={() => setTheme('system')}>
          <Monitor className="mr-2 h-4 w-4" />
          è·Ÿéšç³»ç»Ÿ
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

**Step 3: åœ¨å¯¼èˆªæ æ·»åŠ ä¸»é¢˜åˆ‡æ¢**

```typescript
// components/layout/header.tsx - æ·»åŠ ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
import { ThemeToggle } from '@/components/theme/theme-toggle';

// åœ¨å³ä¾§ä¿¡æ¯åŒºåŸŸæ·»åŠ ï¼ˆåœ¨å€’è®¡æ—¶ä¹‹åï¼‰:
<ThemeToggle />
```

**Step 4: éªŒè¯æ„å»º**

```bash
npm run build
```

**é¢„æœŸè¾“å‡º:** æ„å»ºæˆåŠŸ

**Step 5: æäº¤**

```bash
git add lib/hooks/useTheme.ts components/theme/theme-toggle.tsx components/layout/header.tsx
git commit -m "feat: add dark mode toggle with system preference support"
```

---

### Task 8: å¿«æ·é”®æ”¯æŒ

**Files:**
- Create: `/Users/sundanian/cowork/promotion-coach/app/lib/hooks/useKeyboardShortcuts.ts`
- Create: `/Users/sundanian/cowork/promotion-coach/app/components/practice/keyboard-hints.tsx`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/components/practice/timer-display.tsx`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/app/practice/script/[id]/page.tsx`

**Step 1: åˆ›å»ºå¿«æ·é”® Hook**

```typescript
// lib/hooks/useKeyboardShortcuts.ts
import { useEffect } from 'react';
import { useHotkeys } from 'react-hotkeys-hook';

export interface ShortcutConfig {
  key: string;
  description: string;
  action: () => void;
  scope?: 'global' | 'practice';
}

export function useKeyboardShortcuts(shortcuts: ShortcutConfig[]) {
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // å¿½ç•¥åœ¨è¾“å…¥æ¡†ä¸­çš„æŒ‰é”®
      if (
        e.target instanceof HTMLInputElement ||
        e.target instanceof HTMLTextAreaElement ||
        e.target instanceof HTMLSelectElement
      ) {
        return;
      }

      const shortcut = shortcuts.find((s) => {
        const keys = s.key.split('+').map((k) => k.trim().toLowerCase());
        const eventKeys = [];
        if (e.ctrlKey || e.metaKey) eventKeys.push('ctrl');
        if (e.shiftKey) eventKeys.push('shift');
        if (e.altKey) eventKeys.push('alt');
        eventKeys.push(e.key.toLowerCase());

        return (
          keys.length === eventKeys.length &&
          keys.every((k, i) => k === eventKeys[i])
        );
      });

      if (shortcut) {
        e.preventDefault();
        shortcut.action();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [shortcuts]);
}

// ç»ƒä¹ é¡µé¢ä¸“ç”¨å¿«æ·é”®
export function usePracticeShortcuts(config: {
  onTogglePlay: () => void;
  onReset: () => void;
  onNextSegment?: () => void;
  onPrevSegment?: () => void;
  onToggleFullscreen?: () => void;
}) {
  useHotkeys('space', (e) => {
    e.preventDefault();
    config.onTogglePlay();
  }, { enableOnFormTags: true });

  useHotkeys('ctrl+r,cmd+r', (e) => {
    e.preventDefault();
    config.onReset();
  });

  if (config.onNextSegment) {
    useHotkeys('ctrl+â†’,cmd+â†’', (e) => {
      e.preventDefault();
      config.onNextSegment?.();
    });
  }

  if (config.onPrevSegment) {
    useHotkeys('ctrl+â†,cmd+â†', (e) => {
      e.preventDefault();
      config.onPrevSegment?.();
    });
  }

  if (config.onToggleFullscreen) {
    useHotkeys('f', (e) => {
      e.preventDefault();
      config.onToggleFullscreen();
    });
  }
}
```

**Step 2: åˆ›å»ºå¿«æ·é”®æç¤ºç»„ä»¶**

```typescript
// components/practice/keyboard-hints.tsx
'use client';

import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Keyboard } from 'lucide-react';

const shortcuts = [
  { key: 'ç©ºæ ¼', action: 'æ’­æ”¾/æš‚åœ' },
  { key: 'Ctrl/Cmd + R', action: 'é‡ç½®è®¡æ—¶' },
  { key: 'Ctrl/Cmd + â†’', action: 'ä¸‹ä¸€æ®µè½' },
  { key: 'Ctrl/Cmd + â†', action: 'ä¸Šä¸€æ®µè½' },
  { key: 'F', action: 'å…¨å±æ¨¡å¼' },
  { key: 'Esc', action: 'é€€å‡ºå…¨å±' },
];

export function KeyboardHints() {
  return (
    <Card className="border-dashed">
      <CardContent className="p-4">
        <div className="flex items-center gap-2 mb-3">
          <Keyboard className="w-4 h-4 text-muted-foreground" />
          <span className="text-sm font-medium">å¿«æ·é”®</span>
        </div>
        <div className="grid grid-cols-2 gap-2">
          {shortcuts.map((s, i) => (
            <div key={i} className="flex items-center gap-2 text-xs">
              <Badge variant="outline" className="text-xs">
                {s.key}
              </Badge>
              <span className="text-muted-foreground">{s.action}</span>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
```

**Step 3: åœ¨è®¡æ—¶å™¨ç»„ä»¶ä¸­é›†æˆå¿«æ·é”®**

```typescript
// components/practice/timer-display.tsx - æ·»åŠ å¿«æ·é”®æ”¯æŒ
import { usePracticeShortcuts } from '@/lib/hooks/useKeyboardShortcuts';

// åœ¨ TimerDisplay ç»„ä»¶ä¸­æ·»åŠ :
usePracticeShortcuts({
  onTogglePlay: toggle,
  onReset: reset,
});
```

**Step 4: åœ¨ç»ƒä¹ é¡µé¢æ·»åŠ å¿«æ·é”®æç¤º**

```typescript
// app/practice/script/[id]/page.tsx - æ·»åŠ å¿«æ·é”®æç¤º
import { KeyboardHints } from '@/components/practice/keyboard-hints';

// åœ¨é¡µé¢ä¸­æ·»åŠ ï¼ˆåœ¨ ScriptViewer ä¹‹åï¼‰:
<KeyboardHints />
```

**Step 5: éªŒè¯æ„å»º**

```bash
npm run build
```

**é¢„æœŸè¾“å‡º:** æ„å»ºæˆåŠŸ

**Step 6: æäº¤**

```bash
git add lib/hooks/useKeyboardShortcuts.ts components/practice/keyboard-hints.tsx components/practice/timer-display.tsx
git commit -m "feat: add keyboard shortcuts support for practice page"
```

---

### Task 9: æ²‰æµ¸å¼é˜…è¯»æ¨¡å¼

**Files:**
- Create: `/Users/sundanian/cowork/promotion-coach/app/components/practice/immersive-mode.tsx`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/components/practice/script-viewer.tsx`

**Step 1: åˆ›å»ºæ²‰æµ¸å¼æ¨¡å¼ Hook**

```typescript
// lib/hooks/useImmersiveMode.ts
import { useState, useCallback, useEffect } from 'react';

export function useImmersiveMode() {
  const [isImmersive, setIsImmersive] = useState(false);
  const [fontSize, setFontSize] = useState(18);
  const [focusMode, setFocusMode] = useState(false);

  const toggleImmersive = useCallback(() => {
    setIsImmersive((prev) => !prev);
  }, []);

  const increaseFontSize = useCallback(() => {
    setFontSize((prev) => Math.min(prev + 2, 28));
  }, []);

  const decreaseFontSize = useCallback(() => {
    setFontSize((prev) => Math.max(prev - 2, 14));
  }, []);

  const resetFontSize = useCallback(() => {
    setFontSize(18);
  }, []);

  useEffect(() => {
    if (isImmersive) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    return () => {
      document.body.style.overflow = '';
    };
  }, [isImmersive]);

  return {
    isImmersive,
    fontSize,
    focusMode,
    toggleImmersive,
    setFontSize,
    increaseFontSize,
    decreaseFontSize,
    resetFontSize,
    setFocusMode,
  };
}
```

**Step 2: åˆ›å»ºæ²‰æµ¸å¼æ¨¡å¼ç»„ä»¶**

```typescript
// components/practice/immersive-mode.tsx
'use client';

import { Button } from '@/components/ui/button';
import { Slider } from '@/components/ui/slider';
import { Card } from '@/components/ui/card';
import { Maximize2, Minimize2, Plus, Minus, RotateCcw, Eye } from 'lucide-react';
import { useImmersiveMode } from '@/lib/hooks/useImmersiveMode';
import { cn } from '@/lib/utils';

interface ImmersiveModeProps {
  children: React.ReactNode;
  contentRef?: React.RefObject<HTMLDivElement>;
}

export function ImmersiveMode({ children, contentRef }: ImmersiveModeProps) {
  const {
    isImmersive,
    fontSize,
    focusMode,
    toggleImmersive,
    increaseFontSize,
    decreaseFontSize,
    resetFontSize,
    setFocusMode,
  } = useImmersiveMode();

  if (!isImmersive) {
    return (
      <Button
        variant="outline"
        size="sm"
        onClick={toggleImmersive}
        className="gap-2"
      >
        <Maximize2 className="w-4 h-4" />
        æ²‰æµ¸æ¨¡å¼
      </Button>
    );
  }

  return (
    <div className="fixed inset-0 z-50 bg-background">
      {/* é¡¶éƒ¨å·¥å…·æ  */}
      <div className="sticky top-0 z-10 border-b bg-background/95 backdrop-blur">
        <div className="container flex items-center justify-between py-3">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={toggleImmersive}
            >
              <Minimize2 className="w-5 h-5" />
            </Button>

            <div className="flex items-center gap-2">
              <Button
                variant="ghost"
                size="icon"
                onClick={decreaseFontSize}
              >
                <Minus className="w-4 h-4" />
              </Button>
              <span className="text-sm font-medium w-12 text-center">
                {fontSize}px
              </span>
              <Button
                variant="ghost"
                size="icon"
                onClick={increaseFontSize}
              >
                <Plus className="w-4 h-4" />
              </Button>
              <Button
                variant="ghost"
                size="icon"
                onClick={resetFontSize}
              >
                <RotateCcw className="w-4 h-4" />
              </Button>
            </div>
          </div>

          <Button
            variant={focusMode ? 'default' : 'ghost'}
            size="sm"
            onClick={() => setFocusMode(!focusMode)}
            className="gap-2"
          >
            <Eye className="w-4 h-4" />
            ç„¦ç‚¹æ¨¡å¼
          </Button>
        </div>
      </div>

      {/* å†…å®¹åŒºåŸŸ */}
      <div className="container py-8">
        <div
          ref={contentRef}
          className={cn(
            'max-w-3xl mx-auto transition-all',
            focusMode && 'flex items-center justify-center min-h-[calc(100vh-200px)]'
          )}
        >
          <div
            className={cn(
              'prose prose-lg dark:prose-invert max-w-none',
              focusMode && 'text-center'
            )}
            style={{ fontSize: `${fontSize}px`, lineHeight: '1.8' }}
          >
            {children}
          </div>
        </div>
      </div>
    </div>
  );
}
```

**Step 3: åœ¨ ScriptViewer ä¸­é›†æˆæ²‰æµ¸æ¨¡å¼**

```typescript
// components/practice/script-viewer.tsx - æ·»åŠ æ²‰æµ¸æ¨¡å¼æ”¯æŒ
import { ImmersiveMode } from './immersive-mode';
import { useImmersiveMode } from '@/lib/hooks/useImmersiveMode';

// åœ¨ ScriptViewer ç»„ä»¶ä¸­:
const { isImmersive } = useImmersiveMode();

// åœ¨é€å­—ç¨¿å†…å®¹åŒºåŸŸç”¨ ImmersiveMode åŒ…è£¹
{isImmersive ? (
  <ImmersiveMode contentRef={contentRef}>
    <div className="whitespace-pre-wrap leading-relaxed">
      {content}
    </div>
  </ImmersiveMode>
) : (
  // åŸæœ‰çš„ ScrollArea å†…å®¹
)}
```

**Step 4: éªŒè¯æ„å»º**

```bash
npm run build
```

**é¢„æœŸè¾“å‡º:** æ„å»ºæˆåŠŸ

**Step 5: æäº¤**

```bash
git add lib/hooks/useImmersiveMode.ts components/practice/immersive-mode.tsx components/practice/script-viewer.tsx
git commit -m "feat: add immersive reading mode with font size and focus controls"
```

---

### Task 10: ç§»åŠ¨ç«¯æ‰‹åŠ¿å¯¼èˆª

**Files:**
- Create: `/Users/sundanian/cowork/promotion-coach/app/components/layout/mobile-gestures.tsx`
- Create: `/Users/sundanian/cowork/promotion-coach/app/components/layout/floating-nav.tsx`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/app/layout.tsx`

**Step 1: åˆ›å»ºæ‰‹åŠ¿å¯¼èˆª Hook**

```typescript
// lib/hooks/useSwipeNavigation.ts
import { useEffect, useCallback } from 'react';
import { useRouter, usePathname } from 'next/navigation';

const routes = [
  '/',
  '/practice',
  '/qa',
  '/mindset',
  '/field-guide',
  '/checklist',
  '/quick-ref',
];

export function useSwipeNavigation() {
  const router = useRouter();
  const pathname = usePathname();

  const handleSwipe = useCallback((direction: 'left' | 'right') => {
    const currentIndex = routes.indexOf(pathname);
    if (currentIndex === -1) return;

    let newIndex: number;
    if (direction === 'left') {
      // å‘å·¦æ»‘åŠ¨ -> ä¸‹ä¸€ä¸ªè·¯ç”±
      newIndex = (currentIndex + 1) % routes.length;
    } else {
      // å‘å³æ»‘åŠ¨ -> ä¸Šä¸€ä¸ªè·¯ç”±
      newIndex = (currentIndex - 1 + routes.length) % routes.length;
    }

    router.push(routes[newIndex]);
  }, [pathname, router]);

  return { handleSwipe };
}
```

**Step 2: åˆ›å»ºæµ®åŠ¨å¯¼èˆªç»„ä»¶**

```typescript
// components/layout/floating-nav.tsx
'use client';

import { useState, useEffect } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ChevronLeft, ChevronRight, Menu, X } from 'lucide-react';
import { cn } from '@/lib/utils';
import { useSwipeNavigation } from '@/lib/hooks/useSwipeNavigation';

const navItems = [
  { href: '/', label: 'é¦–é¡µ', icon: 'ğŸ ' },
  { href: '/practice', label: 'ç»ƒä¹ ', icon: 'ğŸ“' },
  { href: '/qa', label: 'é—®ç­”', icon: 'ğŸ’¬' },
  { href: '/mindset', label: 'å¿ƒæ€', icon: 'ğŸ§ ' },
  { href: '/field-guide', label: 'åº”å¯¹', icon: 'âš¡' },
  { href: '/checklist', label: 'æ¸…å•', icon: 'âœ…' },
  { href: '/quick-ref', label: 'å‚è€ƒ', icon: 'ğŸ“–' },
];

export function FloatingNav() {
  const router = useRouter();
  const pathname = usePathname();
  const [isOpen, setIsOpen] = useState(false);
  const [isExpanded, setIsExpanded] = useState(false);
  const { handleSwipe } = useSwipeNavigation();

  const currentIndex = navItems.findIndex((item) => item.href === pathname);
  const prevRoute = navItems[currentIndex > 0 ? currentIndex - 1 : navItems.length - 1];
  const nextRoute = navItems[currentIndex < navItems.length - 1 ? currentIndex + 1 : 0];

  useEffect(() => {
    let touchStartX = 0;
    let touchEndX = 0;

    const onTouchStart = (e: TouchEvent) => {
      touchStartX = e.changedTouches[0].screenX;
    };

    const onTouchEnd = (e: TouchEvent) => {
      touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;

      // æ»‘åŠ¨é˜ˆå€¼ 50px
      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          handleSwipe('left');
        } else {
          handleSwipe('right');
        }
      }
    };

    document.addEventListener('touchstart', onTouchStart);
    document.addEventListener('touchend', onTouchEnd);

    return () => {
      document.removeEventListener('touchstart', onTouchStart);
      document.removeEventListener('touchend', onTouchEnd);
    };
  }, [handleSwipe]);

  return (
    <>
      {/* å¿«é€Ÿåˆ‡æ¢æŒ‰é’® */}
      <div className={cn(
        'fixed bottom-24 left-4 right-4 z-40 flex justify-between px-2 transition-all md:hidden',
        isExpanded ? 'opacity-0 pointer-events-none' : 'opacity-100'
      )}>
        <Button
          size="icon"
          variant="secondary"
          className="h-12 w-12 rounded-full shadow-lg"
          onClick={() => router.push(prevRoute.href)}
        >
          <ChevronLeft className="h-5 w-5" />
        </Button>

        <Button
          size="icon"
          variant="default"
          className="h-14 w-14 rounded-full shadow-lg"
          onClick={() => setIsOpen(!isOpen)}
        >
          {isOpen ? <X className="h-6 w-6" /> : <Menu className="h-6 w-6" />}
        </Button>

        <Button
          size="icon"
          variant="secondary"
          className="h-12 w-12 rounded-full shadow-lg"
          onClick={() => router.push(nextRoute.href)}
        >
          <ChevronRight className="h-5 w-5" />
        </Button>
      </div>

      {/* å±•å¼€çš„å¯¼èˆªèœå• */}
      {isOpen && (
        <div className="fixed inset-0 z-50 bg-background/95 backdrop-blur md:hidden">
          <div className="container h-full flex flex-col">
            <div className="flex items-center justify-between py-4">
              <h2 className="text-lg font-semibold">å¯¼èˆª</h2>
              <Button
                size="icon"
                variant="ghost"
                onClick={() => setIsOpen(false)}
              >
                <X className="h-5 w-5" />
              </Button>
            </div>

            <div className="grid grid-cols-2 gap-3 py-8">
              {navItems.map((item) => {
                const isActive = pathname === item.href;
                return (
                  <button
                    key={item.href}
                    onClick={() => {
                      router.push(item.href);
                      setIsOpen(false);
                    }}
                    className={cn(
                      'flex flex-col items-center gap-2 p-4 rounded-xl transition-all',
                      isActive
                        ? 'bg-primary text-primary-foreground'
                        : 'bg-secondary hover:bg-secondary/80'
                    )}
                  >
                    <span className="text-2xl">{item.icon}</span>
                    <span className="text-sm font-medium">{item.label}</span>
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      )}
    </>
  );
}
```

**Step 3: åœ¨å¸ƒå±€ä¸­é›†æˆæµ®åŠ¨å¯¼èˆª**

```typescript
// app/layout.tsx - æ·»åŠ æµ®åŠ¨å¯¼èˆª
import { FloatingNav } from '@/components/layout/floating-nav';

// åœ¨ body ä¸­ MobileNav ä¹‹åæ·»åŠ :
<FloatingNav />
```

**Step 4: éšè—åŸæœ‰çš„ç§»åŠ¨ç«¯å¯¼èˆªï¼ˆå¯é€‰ï¼‰**

```typescript
// app/layout.tsx - æ³¨é‡Šæ‰åŸæœ‰çš„ MobileNav
{/* <MobileNav /> */}
```

**Step 5: éªŒè¯æ„å»º**

```bash
npm run build
```

**é¢„æœŸè¾“å‡º:** æ„å»ºæˆåŠŸ

**Step 6: æäº¤**

```bash
git add lib/hooks/useSwipeNavigation.ts components/layout/floating-nav.tsx components/layout/mobile-nav.tsx app/layout.tsx
git commit -m "feat: add floating navigation with swipe gestures for mobile"
```

---

### Task 11: é˜¶æ®µè‰²å½©ç³»ç»Ÿ

**Files:**
- Modify: `/Users/sundanian/cowork/promotion-coach/app/app/globals.css`
- Modify: `/Users/sundanian/cowork/promotion-coach/app/lib/store.ts`
- Create: `/Users/sundanian/cowork/promotion-coach/app/lib/hooks/useStageColors.ts`

**Step 1: æ‰©å±•è‰²å½©ç³»ç»Ÿ**

```css
/* app/globals.css - æ·»åŠ é˜¶æ®µè‰² */
:root {
  /* åŸæœ‰è‰²å½©... */

  /* é˜¶æ®µè‰²å½©ç³»ç»Ÿ */
  --stage-preparing: #0066FF;   /* å‡†å¤‡æœŸ - è“è‰² */
  --stage-starting: #8B5CF6;    /* èµ·æ­¥æœŸ - ç´«è‰² */
  --stage-consolidating: #EC4899; /* å·©å›ºæœŸ - ç²‰è‰² */
  --stage-sprinting: #F59E0B;   /* å†²åˆºæœŸ - æ©™è‰² */

  /* é˜¶æ®µè‰²å‰æ™¯ */
  --stage-preparing-foreground: #FFFFFF;
  --stage-starting-foreground: #FFFFFF;
  --stage-consolidating-foreground: #FFFFFF;
  --stage-sprinting-foreground: #FFFFFF;
}

/* é˜¶æ®µè‰²å·¥å…·ç±» */
.stage-preparing { background-color: var(--stage-preparing); }
.stage-starting { background-color: var(--stage-starting); }
.stage-consolidating { background-color: var(--stage-consolidating); }
.stage-sprinting { background-color: var(--stage-sprinting); }

.stage-preparing-text { color: var(--stage-preparing); }
.stage-starting-text { color: var(--stage-starting); }
.stage-consolidating-text { color: var(--stage-consolidating); }
.stage-sprinting-text { color: var(--stage-sprinting); }

/* é˜¶æ®µæ¸å˜ */
.stage-gradient {
  background: linear-gradient(
    90deg,
    var(--stage-preparing) 0%,
    var(--stage-starting) 33%,
    var(--stage-consolidating) 66%,
    var(--stage-sprinting) 100%
  );
}
```

**Step 2: åˆ›å»ºé˜¶æ®µè‰² Hook**

```typescript
// lib/hooks/useStageColors.ts
import { useProgress } from '@/lib/store';

export type Stage = 'preparing' | 'starting' | 'consolidating' | 'sprinting';

export interface StageColors {
  bg: string;
  text: string;
  name: string;
}

export function useStageColors(): StageColors {
  const progress = useProgress();
  const completedDays = progress.completedDays.length;

  const stage: Stage = completedDays === 0
    ? 'preparing'
    : completedDays < 3
    ? 'starting'
    : completedDays < 7
    ? 'consolidating'
    : 'sprinting';

  const stageConfig: Record<Stage, StageColors> = {
    preparing: {
      bg: 'var(--stage-preparing)',
      text: 'var(--stage-preparing)',
      name: 'å‡†å¤‡æœŸ',
    },
    starting: {
      bg: 'var(--stage-starting)',
      text: 'var(--stage-starting)',
      name: 'èµ·æ­¥æœŸ',
    },
    consolidating: {
      bg: 'var(--stage-consolidating)',
      text: 'var(--stage-consolidating)',
      name: 'å·©å›ºæœŸ',
    },
    sprinting: {
      bg: 'var(--stage-sprinting)',
      text: 'var(--stage-sprinting)',
      name: 'å†²åˆºæœŸ',
    },
  };

  return stageConfig[stage];
}

// è·å–é˜¶æ®µè¿›åº¦æ¡æ•°æ®
export function useStageProgress() {
  const progress = useProgress();
  const completedDays = progress.completedDays.length;

  const stages = [
    { id: 'preparing', name: 'å‡†å¤‡æœŸ', endDay: 0, color: 'var(--stage-preparing)' },
    { id: 'starting', name: 'èµ·æ­¥æœŸ', endDay: 3, color: 'var(--stage-starting)' },
    { id: 'consolidating', name: 'å·©å›ºæœŸ', endDay: 7, color: 'var(--stage-consolidating)' },
    { id: 'sprinting', name: 'å†²åˆºæœŸ', endDay: 10, color: 'var(--stage-sprinting)' },
  ];

  const currentStageIndex = stages.findIndex((s, i) => {
    const nextStage = stages[i + 1];
    return completedDays >= s.endDay && (!nextStage || completedDays < nextStage.endDay);
  });

  return {
    stages,
    currentStageIndex,
    currentStage: stages[currentStageIndex],
    progress: stages.map((stage, i) => ({
      ...stage,
      completed: i < currentStageIndex || (i === currentStageIndex && completedDays > stage.endDay),
    })),
  };
}
```

**Step 3: åœ¨è¿›åº¦ç¯ç»„ä»¶ä¸­ä½¿ç”¨é˜¶æ®µè‰²**

```typescript
// components/dashboard/progress-ring.tsx - æ·»åŠ é˜¶æ®µè‰²æ”¯æŒ
import { useStageColors, useStageProgress } from '@/lib/hooks/useStageColors';

// åœ¨ ProgressRing ç»„ä»¶ä¸­:
const stageColors = useStageColors();
const { progress: stageProgress } = useStageProgress();

// ä½¿ç”¨é˜¶æ®µè‰²æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
<div className="flex gap-1">
  {stageProgress.map((stage, i) => (
    <div
      key={i}
      className={cn(
        'flex-1 h-1 rounded-full transition-all duration-500',
        stage.completed ? 'bg-current' : 'bg-secondary'
      )}
      style={{
        backgroundColor: stage.completed ? stage.color : undefined,
        transitionDelay: `${i * 50}ms`,
      }}
    />
  ))}
</div>
```

**Step 4: æ›´æ–°å€’è®¡æ—¶å¡ç‰‡ä½¿ç”¨é˜¶æ®µè‰²**

```typescript
// components/dashboard/countdown-card.tsx - ä½¿ç”¨é˜¶æ®µè‰²
import { useStageColors } from '@/lib/hooks/useStageColors';

// åœ¨ CountdownCard ä¸­ä½¿ç”¨:
const stageColors = useStageColors();

// æ›´æ–° Badge æ ·å¼
<Badge
  style={{
    backgroundColor: stageColors.bg,
    color: stageColors.text,
  }}
>
  {stageColors.name}
</Badge>
```

**Step 5: éªŒè¯æ„å»º**

```bash
npm run build
```

**é¢„æœŸè¾“å‡º:** æ„å»ºæˆåŠŸ

**Step 6: æäº¤**

```bash
git add app/globals.css lib/hooks/useStageColors.ts components/dashboard/progress-ring.tsx components/dashboard/countdown-card.tsx
git commit -m "feat: add stage-based color system (preparing/starting/consolidating/sprinting)"
```

---

## æœ€ç»ˆéªŒè¯

### Task 12: å®Œæ•´åŠŸèƒ½æµ‹è¯•

**Files:**
- Test: å…¨éƒ¨åŠŸèƒ½æµ‹è¯•

**Step 1: è¿è¡Œå¼€å‘æœåŠ¡å™¨**

```bash
npm run dev
```

**Step 2: æ‰‹åŠ¨æµ‹è¯•æ¸…å•**

- [ ] P0-1: æŸ¥çœ‹ç»ƒä¹ è¶‹åŠ¿å›¾æ˜¾ç¤ºæ­£ç¡®
- [ ] P0-1: æŸ¥çœ‹çƒ­åŠ›å›¾é¢œè‰²æ·±æµ…æ­£ç¡®
- [ ] P0-2: æ™ºèƒ½æ¨èæ ¹æ®ç»ƒä¹ æ•°æ®å˜åŒ–
- [ ] P1-1: å½•éŸ³åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] P1-2: PDF å¯¼å‡ºç”Ÿæˆæ–‡ä»¶
- [ ] UX-1: æ·±è‰²æ¨¡å¼åˆ‡æ¢æ­£å¸¸
- [ ] UX-2: å¿«æ·é”®å“åº”æ­£ç¡®
- [ ] UX-3: æ²‰æµ¸æ¨¡å¼è¿›å…¥/é€€å‡º
- [ ] UX-4: ç§»åŠ¨ç«¯æ‰‹åŠ¿æ»‘åŠ¨å¯¼èˆª
- [ ] UX-5: é˜¶æ®µé¢œè‰²éšè¿›åº¦å˜åŒ–

**Step 3: æœ€ç»ˆæ„å»ºéªŒè¯**

```bash
npm run build
npm run start
```

**é¢„æœŸè¾“å‡º:** æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼Œç”Ÿäº§ç¯å¢ƒè¿è¡Œç¨³å®š

**Step 4: åˆ›å»ºæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰**

```bash
git tag -a v1.1.0 -m "Release P0/P1 features and UX improvements"
git push origin v1.1.0
```

---

## è®¡åˆ’å®Œæˆ

æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼åº”ç”¨ç°åœ¨åŒ…å«ï¼š

**P0 åŠŸèƒ½:**
- âœ… ç»ƒä¹ æ•°æ®å¯è§†åŒ–ï¼ˆè¶‹åŠ¿å›¾ã€çƒ­åŠ›å›¾ã€æ®µè½åˆ†å¸ƒï¼‰
- âœ… æ™ºèƒ½æ¨èè–„å¼±ç¯èŠ‚

**P1 åŠŸèƒ½:**
- âœ… è¯­éŸ³å½•éŸ³è®°å½•
- âœ… PDF ç»ƒä¹ æŠ¥å‘Šå¯¼å‡º

**UI/UX æ”¹è¿›:**
- âœ… æ·±è‰²æ¨¡å¼åˆ‡æ¢
- âœ… å¿«æ·é”®æ”¯æŒ
- âœ… æ²‰æµ¸å¼é˜…è¯»æ¨¡å¼
- âœ… ç§»åŠ¨ç«¯æ‰‹åŠ¿å¯¼èˆª
- âœ… é˜¶æ®µè‰²å½©ç³»ç»Ÿ
